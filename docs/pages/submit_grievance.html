 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submit Grievance - GrievMitra Portal</title>
    <meta name="description" content="Submit your grievance through our comprehensive multi-step wizard. Get AI-powered suggestions, real-time validation, and immediate acknowledgment with tracking ID." />
    <link rel="stylesheet" href="../css/main.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fgrievmitra7175back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
</head>
<body class="bg-background">
    <!-- Reusable Navigation Component -->
<nav class="bg-white shadow-subtle sticky top-0 z-50 border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <!-- Logo -->
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-10 w-10 text-primary transition-transform duration-200 hover:scale-105" viewBox="0 0 40 40" fill="currentColor">
                        <path d="M20 4C11.163 4 4 11.163 4 20s7.163 16 16 16 16-7.163 16-16S28.837 4 20 4zm0 28c-6.627 0-12-5.373-12-12S13.373 8 20 8s12 5.373 12 12-5.373 12-12 12z"/>
                        <path d="M20 12c-4.411 0-8 3.589-8 8s3.589 8 8 8 8-3.589 8-8-3.589-8-8-8zm0 12c-2.206 0-4-1.794-4-4s1.794-4 4-4 4 1.794 4 4-1.794 4-4 4z"/>
                        <circle cx="20" cy="20" r="2" fill="white"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <h1 class="text-xl font-bold text-primary">GrievMitra</h1>
                    <p class="text-xs text-text-secondary">Portal</p>
                </div>
            </div>

            <!-- Desktop Navigation -->
            <div class="hidden md:block">
                <div class="ml-10 flex items-baseline space-x-4">
                    <a href="homepage.html" class="nav-link text-text-secondary hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:bg-primary-50">Home</a>
                    <a href="submit_grievance.html" class="nav-link text-text-secondary hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:bg-primary-50">Submit Grievance</a>
                    <a href="track_grievance.html" class="nav-link text-text-secondary hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:bg-primary-50">Track Status</a>
                    <a href="transparency_dashboard.html" class="nav-link text-text-secondary hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:bg-primary-50">Transparency</a>
                    <a href="about_griev_mitra.html" class="nav-link text-text-secondary hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-all duration-200 hover:bg-primary-50">About</a>
                </div>
            </div>

            <!-- User Menu / Auth Buttons -->
            <div class="flex items-center space-x-4">
                <!-- User Menu (when logged in) -->
                <div id="user-menu" class="hidden relative">
                    <button id="user-menu-button" class="flex items-center space-x-2 text-sm rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary p-1 hover:bg-gray-50 transition-colors duration-200">
                        <div id="profile-photo" class="h-8 w-8 rounded-full bg-primary flex items-center justify-center text-white font-medium text-sm">
                            <span id="user-initials">U</span>
                        </div>
                        <span id="user-display-name" class="hidden md:block text-text-primary font-medium"></span>
                        <svg class="h-4 w-4 text-text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </button>

                    <!-- Dropdown Menu -->
                    <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 border border-gray-200">
                        <div class="px-4 py-2 border-b border-gray-200">
                            <p class="text-sm font-medium text-text-primary" id="dropdown-user-name">User Name</p>
                            <p class="text-xs text-text-secondary" id="dropdown-user-email">user@example.com</p>
                        </div>
                        <a href="user_profile.html" class="block px-4 py-2 text-sm text-text-primary hover:bg-gray-50 transition-colors duration-200">
                            <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            My Profile
                        </a>
                        <a href="user_grievances.html" class="block px-4 py-2 text-sm text-text-primary hover:bg-gray-50 transition-colors duration-200">
                            <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            My Grievances
                        </a>
                        <a href="admin_dashboard.html" id="admin-link-desktop" class="hidden block px-4 py-2 text-sm text-text-primary hover:bg-gray-50 transition-colors duration-200">
                            <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Admin Dashboard
                        </a>
                        <div class="border-t border-gray-200 my-1"></div>
                        <button id="logout-link" class="w-full text-left px-4 py-2 text-sm text-error hover:bg-error-50 transition-colors duration-200">
                            <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </button>
                    </div>
                </div>

                <!-- Auth Buttons (when not logged in) -->
                <div id="auth-buttons" class="hidden md:flex items-center space-x-3">
                    <a href="login_screen.html" id="login-link" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">Login</a>
                    <a href="user_registration.html" class="bg-primary text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-primary-600 transition-all duration-200 transform hover:scale-105 shadow-md hover:shadow-lg">Register</a>
                </div>

                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-text-secondary hover:text-primary p-2 rounded-md transition-colors duration-200">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Navigation Menu -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200 bg-white">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="homepage.html" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-text-secondary hover:text-primary hover:bg-primary-50 transition-colors duration-200">Home</a>
                <a href="submit_grievance.html" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-text-secondary hover:text-primary hover:bg-primary-50 transition-colors duration-200">Submit Grievance</a>
                <a href="track_grievance.html" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-text-secondary hover:text-primary hover:bg-primary-50 transition-colors duration-200">Track Status</a>
                <a href="transparency_dashboard.html" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-text-secondary hover:text-primary hover:bg-primary-50 transition-colors duration-200">Transparency</a>
                <a href="about_griev_mitra.html" class="mobile-nav-link block px-3 py-2 rounded-md text-base font-medium text-text-secondary hover:text-primary hover:bg-primary-50 transition-colors duration-200">About</a>

                <!-- Mobile Auth Buttons -->
                <div id="mobile-auth-buttons" class="pt-4 pb-3 border-t border-gray-200">
                    <div class="flex items-center px-5">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 rounded-full bg-primary flex items-center justify-center text-white font-medium">
                                <span id="mobile-user-initials">U</span>
                            </div>
                        </div>
                        <div class="ml-3">
                            <div id="mobile-user-name" class="text-base font-medium text-text-primary">User Name</div>
                            <div id="mobile-user-email" class="text-sm font-medium text-text-secondary">user@example.com</div>
                        </div>
                    </div>
                    <div class="mt-3 space-y-1">
                        <a href="user_profile.html" class="block px-3 py-2 rounded-md text-base font-medium text-text-secondary hover:text-primary hover:bg-primary-50 transition-colors duration-200">
                            <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                            My Profile
                        </a>
                        <a href="#" class="block px-3 py-2 rounded-md text-base font-medium text-text-secondary hover:text-primary hover:bg-primary-50 transition-colors duration-200">
                            <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            My Grievances
                        </a>
                        <a href="admin_dashboard.html" id="admin-link-mobile" class="hidden block px-3 py-2 rounded-md text-base font-medium text-text-secondary hover:text-primary hover:bg-primary-50 transition-colors duration-200">
                            <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Admin Dashboard
                        </a>
                        <button id="logout-link-mobile-menu" class="w-full text-left block px-3 py-2 rounded-md text-base font-medium text-error hover:bg-error-50 transition-colors duration-200">
                            <svg class="inline w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- Navigation JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Check authentication status
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    const name = localStorage.getItem('name');
    const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';

        if (token && isLoggedIn) {
            // User is logged in
            document.getElementById('user-menu').classList.remove('hidden');
            document.getElementById('mobile-auth-buttons').classList.remove('hidden');
            document.getElementById('auth-buttons').classList.add('hidden');
            // Set user information
        const userInitials = name ? name.split(' ').map(n => n[0]).join('').toUpperCase() : 'U';
        document.getElementById('user-initials').textContent = userInitials;
        document.getElementById('mobile-user-initials').textContent = userInitials;
        document.getElementById('user-display-name').textContent = name || 'User';
        document.getElementById('dropdown-user-name').textContent = name || 'User';
        document.getElementById('mobile-user-name').textContent = name || 'User';

        // Get user email - first check localStorage, then fetch from backend if needed
        let userEmail = localStorage.getItem('email');
        if (userEmail) {
            document.getElementById('dropdown-user-email').textContent = userEmail;
            document.getElementById('mobile-user-email').textContent = userEmail;
        } else {
            // Fetch email from backend if not in localStorage
            const apiBaseUrl = `${window.location.protocol}//${window.location.hostname}:5000`;
            fetch(`${apiBaseUrl}/auth/profile`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.email) {
                    localStorage.setItem('email', data.email);
                    document.getElementById('dropdown-user-email').textContent = data.email;
                    document.getElementById('mobile-user-email').textContent = data.email;
                } else {
                    document.getElementById('dropdown-user-email').textContent = 'user@example.com';
                    document.getElementById('mobile-user-email').textContent = 'user@example.com';
                }
            })
            .catch(error => {
                console.log('Could not fetch user email:', error);
                document.getElementById('dropdown-user-email').textContent = 'user@example.com';
                document.getElementById('mobile-user-email').textContent = 'user@example.com';
            });
        }

        // Show admin links if user is admin
        if (role === 'admin') {
            document.getElementById('admin-link-desktop').classList.remove('hidden');
            document.getElementById('admin-link-mobile').classList.remove('hidden');
        }
    } else {
        // User is not logged in
        document.getElementById('auth-buttons').classList.remove('hidden');
        document.getElementById('user-menu').classList.add('hidden');
    }

    // Mobile menu toggle
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');

    mobileMenuButton?.addEventListener('click', function() {
        mobileMenu.classList.toggle('hidden');
    });

    // User dropdown toggle
    const userMenuButton = document.getElementById('user-menu-button');
    const userDropdown = document.getElementById('user-dropdown');

    userMenuButton?.addEventListener('click', function(e) {
        e.stopPropagation();
        userDropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!userMenuButton?.contains(e.target)) {
            userDropdown?.classList.add('hidden');
        }
    });

    // Logout functionality
    const logoutButtons = document.querySelectorAll('#logout-link, #logout-link-mobile-menu');
    logoutButtons.forEach(button => {
        button?.addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.clear();
            window.location.href = 'login_screen.html';
        });
    });

    // Highlight current page in navigation
    const currentPath = window.location.pathname.split('/').pop() || 'homepage.html';
    const navLinks = document.querySelectorAll('.nav-link, .mobile-nav-link');

    navLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href === currentPath) {
            link.classList.add('text-primary', 'bg-primary-50');
            link.classList.remove('text-text-secondary');
        }
    });
});
</script>

    <!-- Progress Indicator -->
    <section class="bg-white border-b border-border">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between mb-4">
                <h1 class="text-2xl font-bold text-text-primary">Submit New Grievance</h1>
                <div class="text-sm text-text-secondary">
                    Step <span id="current-step">1</span> of 4
                </div>
            </div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill" style="width: 25%"></div>
            </div>
            <div class="flex justify-between mt-2 text-xs text-text-secondary">
                <span class="font-medium text-primary">Category</span>
                <span>Details</span>
                <span>Location</span>
                <span>Review</span>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Step 1: Category Selection -->
        <div id="step-1" class="step-content">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-text-primary mb-4">What type of issue would you like to report?</h2>
                <p class="text-lg text-text-secondary max-w-2xl mx-auto">
                    Select the category that best describes your grievance. This helps us route your complaint to the right department for faster resolution.
                </p>
            </div>

            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Infrastructure Category -->
                <div class="category-card card cursor-pointer hover:shadow-modal transition-all duration-300 group" data-category="infrastructure">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-primary-200 transition-colors">
                            <svg class="w-8 h-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-text-primary mb-2">Infrastructure</h3>
                        <p class="text-text-secondary text-sm">Roads, bridges, water supply, electricity, drainage issues</p>
                        <div class="mt-3 text-xs text-success font-medium">Avg. Resolution: 5-7 days</div>
                    </div>
                </div>

                <!-- Public Services Category -->
                <div class="category-card card cursor-pointer hover:shadow-modal transition-all duration-300 group" data-category="public-services">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-secondary-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-secondary-200 transition-colors">
                            <svg class="w-8 h-8 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-text-primary mb-2">Public Services</h3>
                        <p class="text-text-secondary text-sm">Healthcare, education, transport, documentation services</p>
                        <div class="mt-3 text-xs text-success font-medium">Avg. Resolution: 3-5 days</div>
                    </div>
                </div>

                <!-- Corruption Category -->
                <div class="category-card card cursor-pointer hover:shadow-modal transition-all duration-300 group" data-category="corruption">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-error-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-error-200 transition-colors">
                            <svg class="w-8 h-8 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-text-primary mb-2">Corruption</h3>
                        <p class="text-text-secondary text-sm">Bribery, misuse of power, unfair practices by officials</p>
                        <div class="mt-3 text-xs text-warning font-medium">Avg. Resolution: 7-10 days</div>
                    </div>
                </div>

                <!-- Environmental Category -->
                <div class="category-card card cursor-pointer hover:shadow-modal transition-all duration-300 group" data-category="environmental">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-success-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-success-200 transition-colors">
                            <svg class="w-8 h-8 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-text-primary mb-2">Environmental</h3>
                        <p class="text-text-secondary text-sm">Pollution, waste management, illegal construction, noise</p>
                        <div class="mt-3 text-xs text-success font-medium">Avg. Resolution: 4-6 days</div>
                    </div>
                </div>

                <!-- Safety & Security Category -->
                <div class="category-card card cursor-pointer hover:shadow-modal transition-all duration-300 group" data-category="safety">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-accent-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-accent-200 transition-colors">
                            <svg class="w-8 h-8 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-text-primary mb-2">Safety & Security</h3>
                        <p class="text-text-secondary text-sm">Public safety, law enforcement, emergency services</p>
                        <div class="mt-3 text-xs text-warning font-medium">Avg. Resolution: 2-4 days</div>
                    </div>
                </div>

                <!-- Other Category -->
                <div class="category-card card cursor-pointer hover:shadow-modal transition-all duration-300 group" data-category="other">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:bg-gray-200 transition-colors">
                            <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-text-primary mb-2">Other Issues</h3>
                        <p class="text-text-secondary text-sm">Issues not covered in above categories</p>
                        <div class="mt-3 text-xs text-text-secondary font-medium">Avg. Resolution: 5-8 days</div>
                    </div>
                </div>
            </div>

            <!-- AI Suggestions -->
            <div id="ai-suggestions" class="hidden bg-primary-50 rounded-xl p-6 mb-8">
                <div class="flex items-start">
                    <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h4 class="font-semibold text-text-primary mb-2">AI-Powered Suggestions</h4>
                        <p class="text-text-secondary mb-3">Based on your selection, here are similar issues that were recently resolved:</p>
                        <div id="suggestion-list" class="space-y-2">
                            <!-- Dynamic suggestions will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end">
                <button id="next-step-1" class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Continue to Details
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Step 2: Details -->
        <div id="step-2" class="step-content hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-text-primary mb-4">Describe Your Grievance</h2>
                <p class="text-lg text-text-secondary">
                    Provide detailed information about your issue. The more specific you are, the better we can help resolve it.
                </p>
            </div>

            <div class="space-y-6">
                <!-- Category (editable in step 2) -->
                <div>
                    <label for="step2-category" class="block text-sm font-medium text-text-primary mb-2">
                        Category <span class="text-error">*</span>
                    </label>
                    <select id="step2-category" class="form-input">
                        <option value="">Select Category</option>
                        <option value="infrastructure">Infrastructure</option>
                        <option value="public-services">Public Services</option>
                        <option value="corruption">Corruption</option>
                        <option value="environmental">Environmental</option>
                        <option value="safety">Safety & Security</option>
                        <option value="other">Other Issues</option>
                    </select>
                </div>

                <!-- Subject -->
                <div>
                    <label for="subject" class="block text-sm font-medium text-text-primary mb-2">
                        Subject <span class="text-error">*</span>
                    </label>
                    <input type="text" id="subject" name="subject" class="form-input" placeholder="Brief summary of your issue" maxlength="100" />
                    <div class="flex justify-between mt-1">
                        <p class="text-xs text-text-secondary">Be specific and concise</p>
                        <span id="subject-count" class="text-xs text-text-secondary">0/100</span>
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label for="description" class="block text-sm font-medium text-text-primary mb-2">
                        Detailed Description <span class="text-error">*</span>
                    </label>
                    <div class="relative">
                        <textarea id="description" name="description" rows="6" class="form-input pr-12" placeholder="Describe your issue in detail. Include what happened, when it occurred, and how it affects you or your community..."></textarea>
                        <button type="button" id="voice-input" class="absolute top-3 right-3 p-2 text-text-secondary hover:text-primary transition-colors">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="flex justify-between mt-1">
                        <p class="text-xs text-text-secondary">Include dates, times, and specific details</p>
                        <span id="description-count" class="text-xs text-text-secondary">0/2000</span>
                    </div>
                </div>

                <!-- Priority Level -->
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">Priority Level</label>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                        <label class="priority-option cursor-pointer">
                            <input type="radio" name="priority" value="low" class="sr-only" />
                            <div class="border-2 border-gray-200 rounded-lg p-4 text-center hover:border-success transition-colors">
                                <div class="w-8 h-8 bg-success-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <div class="w-3 h-3 bg-success rounded-full"></div>
                                </div>
                                <div class="font-medium text-text-primary">Low</div>
                                <div class="text-xs text-text-secondary">Non-urgent issue</div>
                            </div>
                        </label>
                        <label class="priority-option cursor-pointer">
                            <input type="radio" name="priority" value="medium" class="sr-only" />
                            <div class="border-2 border-gray-200 rounded-lg p-4 text-center hover:border-warning transition-colors">
                                <div class="w-8 h-8 bg-warning-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <div class="w-3 h-3 bg-warning rounded-full"></div>
                                </div>
                                <div class="font-medium text-text-primary">Medium</div>
                                <div class="text-xs text-text-secondary">Moderate urgency</div>
                            </div>
                        </label>
                        <label class="priority-option cursor-pointer">
                            <input type="radio" name="priority" value="high" class="sr-only" />
                            <div class="border-2 border-gray-200 rounded-lg p-4 text-center hover:border-error transition-colors">
                                <div class="w-8 h-8 bg-error-100 rounded-full flex items-center justify-center mx-auto mb-2">
                                    <div class="w-3 h-3 bg-error rounded-full"></div>
                                </div>
                                <div class="font-medium text-text-primary">High</div>
                                <div class="text-xs text-text-secondary">Urgent attention needed</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Community Impact -->
                <div class="bg-accent-50 rounded-xl p-6">
                    <div class="flex items-start">
                        <input type="checkbox" id="community-impact" class="mt-1 mr-3" />
                        <div>
                            <label for="community-impact" class="font-medium text-text-primary cursor-pointer">
                                Mark as Community Impact Issue
                            </label>
                            <p class="text-text-secondary text-sm mt-1">
                                This issue affects multiple people in my area and would benefit from community support and visibility.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Document Upload -->
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">
                        Supporting Documents
                    </label>
                    <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors cursor-pointer">
                        <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        <p class="text-text-primary font-medium mb-2">Drop files here or click to upload</p>
                        <p class="text-text-secondary text-sm">Photos, videos, PDFs up to 10MB each</p>
                        <input type="file" id="file-input" class="hidden" multiple accept="image/*,video/*,.pdf" />
                    </div>
                    <div id="file-preview" class="mt-4 space-y-2 hidden">
                        <!-- File previews will be inserted here -->
                    </div>
                </div>
            </div>

            <div class="flex justify-between mt-8">
                <button id="prev-step-2" class="bg-gray-200 text-text-primary px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                    <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/>
                    </svg>
                    Back to Category
                </button>
                <button id="next-step-2" class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Continue to Location
                    <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Step 3: Location -->
       <!-- Step 3: Location -->
<div id="step-3" class="step-content hidden">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-text-primary mb-4">Where did this issue occur?</h2>
        <p class="text-lg text-text-secondary">
            Provide the exact location of the issue. This helps us assign it to the correct local authority.
        </p>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">
        <!-- Address Form -->
        <div class="space-y-6">

            <!-- Address + Use My Location -->
            <div>
                <label for="address" class="block text-sm font-medium text-text-primary mb-2">
                    Street Address <span class="text-error">*</span>
                </label>
                <input type="text" id="address" class="form-input" placeholder="Enter street address" />

               <button type="button" id="detect-location"
    class="mt-2 inline-flex items-center gap-2 px-3 py-2 bg-primary rounded-full text-white text-sm font-medium hover:bg-primary-700 transition">

    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>

    <span>Use my current location</span>
</button>

            </div>

            <!-- City + State -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">City <span class="text-error">*</span></label>
                    <input type="text" id="city" class="form-input" placeholder="City" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">State/UT <span class="text-error">*</span></label>
                    <input type="text" id="state" class="form-input"
                        placeholder="e.g., Maharashtra, Delhi, Karnataka" />
                </div>
            </div>

            <!-- District + PIN -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">District <span class="text-error">*</span></label>
                    <input type="text" id="district" class="form-input" placeholder="District" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-text-primary mb-2">PIN Code <span class="text-error">*</span></label>
                    <input type="text" id="pincode" maxlength="6" class="form-input" placeholder="6-digit PIN code" />
                </div>
            </div>

            <!-- Landmark -->
            <div>
                <label class="block text-sm font-medium text-text-primary mb-2">Nearby Landmark</label>
                <input type="text" id="landmark" class="form-input" placeholder="Nearby landmark or reference point" />
            </div>
        </div>

        <!-- Live Map -->
        <div class="bg-gray-100 rounded-xl p-2">
            <div id="map" class="w-full h-96 rounded-xl"></div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="flex justify-between mt-8">
        <button id="prev-step-3"
            class="bg-gray-200 text-text-primary px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
            <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M7 16l-4-4m0 0l4-4m-4 4h18" />
            </svg>
            Back to Details
        </button>

        <button id="next-step-3"
            class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
            Review & Submit
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
        </button>
    </div>
</div>

<script>
// ------------------- MAP + LOCATION HANDLER --------------------
let map = L.map('map').setView([20.5937, 78.9629], 5); // India view

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
}).addTo(map);

let marker = null;

// Update form fields after reverse geocoding
function updateLocationFields(lat, lon) {
    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
        .then(res => res.json())
        .then(data => {
            let addr = data.address;

            document.getElementById("address").value = data.display_name || "";
            document.getElementById("city").value = addr.city || addr.town || addr.village || "";
            document.getElementById("state").value = addr.state || "";
            document.getElementById("district").value = addr.county || addr.suburb || "";
            document.getElementById("pincode").value = addr.postcode || "";

            validateAfterAutoFill();
        });
}

// Place & drag marker
function placeMarker(lat, lon) {
    if (marker) map.removeLayer(marker);

    marker = L.marker([lat, lon], { draggable: true }).addTo(map);

    marker.on('dragend', function () {
        let pos = marker.getLatLng();
        updateLocationFields(pos.lat, pos.lng);
    });

    updateLocationFields(lat, lon);
}

// Use my current location
document.getElementById("detect-location").addEventListener("click", () => {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            let lat = position.coords.latitude;
            let lon = position.coords.longitude;

            map.setView([lat, lon], 17);
            placeMarker(lat, lon);
        });
    } else {
        alert("Location permission denied!");
    }
});

// Click on map to place marker
map.on("click", function (e) {
    placeMarker(e.latlng.lat, e.latlng.lng);
});


// ---------------- ENABLE SUBMIT ONLY WHEN VALID ----------------
const requiredFields = ["address", "city", "state", "district", "pincode"];
const submitBtn = document.getElementById("next-step-3");

function validateStep3() {
    let isValid = true;

    requiredFields.forEach(id => {
        let value = document.getElementById(id).value.trim();

        if (id === "pincode") {
            if (!/^[0-9]{6}$/.test(value)) {
                isValid = false;
            }
        } else {
            if (value.length === 0) isValid = false;
        }
    });

    submitBtn.disabled = !isValid;
}

// Trigger validation on typing
requiredFields.forEach(id => {
    document.getElementById(id).addEventListener("input", validateStep3);
});

// Validate after map auto-fills values
function validateAfterAutoFill() {
    setTimeout(validateStep3, 300);
}
</script>


        <!-- Step 4: Review & Submit -->
        <div id="step-4" class="step-content hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-text-primary mb-4">Review Your Grievance</h2>
                <p class="text-lg text-text-secondary">
                    Please review all the information before submitting. You can go back to make changes if needed.
                </p>
            </div>

            <div class="space-y-6">
                <!-- Review Summary -->
                <div class="card">
                    <div class="flex items-start justify-between mb-4">
                        <h3 class="text-lg font-semibold text-text-primary">Grievance Summary</h3>
                        <span id="review-priority" class="status-badge status-warning">Medium Priority</span>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <dt class="text-sm font-medium text-text-secondary">Category</dt>
                            <dd id="review-category" class="text-text-primary">Infrastructure</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-text-secondary">Subject</dt>
                            <dd id="review-subject" class="text-text-primary">Pothole on Main Street causing accidents</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-text-secondary">Description</dt>
                            <dd id="review-description" class="text-text-primary">Large pothole has formed on Main Street near the bus stop...</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-text-secondary">Location</dt>
                            <dd id="review-location" class="text-text-primary">123 Main Street, Mumbai, Maharashtra - 400001</dd>
                        </div>
                    </div>
                </div>

                <!-- Expected Timeline -->
                <div class="card bg-primary-50">
                    <div class="flex items-start">
                        <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center mr-4 flex-shrink-0">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-text-primary mb-2">Expected Timeline</h4>
                            <p class="text-text-secondary mb-3">Based on your category and priority level:</p>
                            <div class="space-y-2">
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-success rounded-full mr-3"></div>
                                    <span class="text-sm text-text-secondary">Acknowledgment: Within 24 hours</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-warning rounded-full mr-3"></div>
                                    <span class="text-sm text-text-secondary">Assignment to Department: 1-2 days</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-2 h-2 bg-primary rounded-full mr-3"></div>
                                    <span class="text-sm text-text-secondary">Expected Resolution: 5-7 days</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Assigned Department -->
                <div class="card">
                    <h4 class="font-semibold text-text-primary mb-3">Assigned Department</h4>
                    <div class="flex items-center">
                        <div class="w-12 h-12 bg-secondary-100 rounded-full flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-secondary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <div>
                            <div class="font-medium text-text-primary">Public Works Department</div>
                            <div class="text-text-secondary text-sm">Municipal Corporation of Greater Mumbai</div>
                        </div>
                    </div>
                </div>

                <!-- Terms and Conditions -->
                <div class="bg-gray-50 rounded-xl p-6">
                    <div class="flex items-start">
                        <input type="checkbox" id="terms-agreement" class="mt-1 mr-3" />
                        <div>
                            <label for="terms-agreement" class="font-medium text-text-primary cursor-pointer">
                                I agree to the terms and conditions
                            </label>
                            <p class="text-text-secondary text-sm mt-1">
                                I confirm that the information provided is accurate and I understand that false complaints may result in legal action. I also consent to the processing of my personal data for grievance resolution purposes.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between mt-8">
                <button id="prev-step-4" class="bg-gray-200 text-text-primary px-6 py-3 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                    <svg class="w-5 h-5 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"/>
                    </svg>
                    Back to Location
                </button>
                <button id="submit-grievance" class="btn-primary disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                    Submit Grievance
                </button>
            </div>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
            <div class="w-16 h-16 bg-success-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-text-primary mb-4">Grievance Submitted Successfully!</h3>
            <p class="text-text-secondary mb-6">Your grievance has been registered and assigned a unique tracking ID.</p>

            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="text-sm text-text-secondary mb-1">Tracking ID</div>
                <div class="text-2xl font-bold text-primary font-mono" id="tracking-id">GRV-2025-001234</div>
                <div class="mt-3">
                    <img src="https://images.unsplash.com/photo-1606166187734-a4cb74079037?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.0.3" alt="QR Code" class="w-24 h-24 mx-auto" onerror="this.src='https://images.pexels.com/photos/4386431/pexels-photo-4386431.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=2'; this.onerror=null;" />
                    <p class="text-xs text-text-secondary mt-2">Scan QR code for quick tracking</p>
                </div>
            </div>

            <div class="space-y-3">
                <a href="track_grievance.html" class="btn-primary w-full inline-block">
                    Track Your Grievance
                </a>
                <a href="user_profile.html" class="w-full px-6 py-3 bg-secondary text-white rounded-lg font-semibold hover:bg-secondary-600 transition-colors inline-block text-center">
                    View My Profile
                </a>
                <button onclick="closeSuccessModal()" class="w-full px-6 py-3 text-text-secondary hover:text-text-primary transition-colors">
                    Submit Another Grievance
                </button>
            </div>
        </div>
    </div>

    <!-- Login Prompt Modal -->
    <div id="login-prompt-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
            <div class="w-16 h-16 bg-warning-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.464 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-text-primary mb-4">Login Required</h3>
            <p class="text-text-secondary mb-6">You need to be logged in to submit a grievance. Please login or register to continue.</p>

            <div class="space-y-3">
                <a href="login_screen.html" class="btn-primary w-full inline-block">
                    Login
                </a>
                <a href="user_registration.html" class="w-full px-6 py-3 text-text-secondary hover:text-text-primary transition-colors inline-block">
                    Register New Account
                </a>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-text-primary text-white py-12 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid md:grid-cols-4 gap-8">
                <!-- Brand -->
                <div class="md:col-span-2">
                    <div class="flex items-center mb-4">
                        <svg class="h-8 w-8 text-primary" viewBox="0 0 40 40" fill="currentColor">
                            <path d="M20 4C11.163 4 4 11.163 4 20s7.163 16 16 16 16-7.163 16-16S28.837 4 20 4zm0 28c-6.627 0-12-5.373-12-12S13.373 8 20 8s12 5.373 12 12-5.373 12-12 12z"/>
                            <path d="M20 12c-4.411 0-8 3.589-8 8s3.589 8 8 8 8-3.589 8-8-3.589-8-8-8zm0 12c-2.206 0-4-1.794-4-4s1.794-4 4-4 4 1.794 4 4-1.794 4-4 4z"/>
                            <circle cx="20" cy="20" r="2" fill="white"/>
                        </svg>
                        <div class="ml-3">
                            <h3 class="text-xl font-bold">GrievMitra Portal</h3>
                            <p class="text-gray-300 text-sm">Your Voice, Our Mission</p>
                        </div>
                    </div>
                    <p class="text-gray-300 mb-4 max-w-md">
                        Transforming governance through transparency, accountability, and citizen empowerment. Every voice matters, every grievance counts.
                    </p>
                </div>

                <!-- Quick Links -->
                <div>
                    <h4 class="font-semibold mb-4">Quick Links</h4>
                    <ul class="space-y-2">
                        <li><a href="submit_grievance.html" class="text-gray-300 hover:text-white transition-colors">Submit Grievance</a></li>
                        <li><a href="track_grievance.html" class="text-gray-300 hover:text-white transition-colors">Track Status</a></li>
                        <li><a href="transparency_dashboard.html" class="text-gray-300 hover:text-white transition-colors">Transparency</a></li>
                        <li><a href="about_griev_mitra.html" class="text-gray-300 hover:text-white transition-colors">About Us</a></li>
                    </ul>
                </div>

                <!-- Contact -->
                <div>
                    <h4 class="font-semibold mb-4">Support</h4>
                    <ul class="space-y-2">
                        <li class="text-gray-300">Helpline: 1800-123-4567</li>
                        <li class="text-gray-300">Email: support@grievmitra.gov.in</li>
                        <li class="text-gray-300">24/7 Citizen Support</li>
                    </ul>
                </div>
            </div>

            <div class="border-t border-gray-700 mt-8 pt-8 text-center">
                <p class="text-gray-300">
                    Â© 2025 GrievMitra Portal. All Rights Reserved. | A Digital India Initiative
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let currentStep = 1;
        let selectedCategory = '';
        let formData = {};

        // Check login status and update header
        function updateHeader() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const userRole = localStorage.getItem('role'); // 'admin' or 'citizen' or 'leader'
            const userName = localStorage.getItem('name') || 'User';

            const registerLinks = document.querySelectorAll('#register-link');
            const loginLinks = document.querySelectorAll('#login-link');
            const userMenu = document.getElementById('user-menu');
            const userMenuMobile = document.getElementById('user-menu-mobile');
            const welcomeMessage = document.getElementById('welcome-message');
            const welcomeMessageMobile = document.getElementById('welcome-message-mobile');
            const adminLinkDesktop = document.getElementById('admin-link-desktop');
            const adminLinkMobile = document.getElementById('admin-link-mobile');

            if (isLoggedIn) {
                // Hide login/register
                registerLinks.forEach(link => link.style.display = 'none');
                loginLinks.forEach(link => link.style.display = 'none');

                // Show user menu
                if (userMenu) userMenu.style.display = 'flex';
                if (userMenuMobile) userMenuMobile.style.display = 'block';
                if (welcomeMessage) welcomeMessage.textContent = `Welcome, ${userName}`;
                if (welcomeMessageMobile) welcomeMessageMobile.textContent = `Welcome, ${userName}`;

                // Show admin links only for admin users
                if (userRole === 'admin') {
                    if (adminLinkDesktop) adminLinkDesktop.style.display = 'inline-flex';
                    if (adminLinkMobile) adminLinkMobile.style.display = 'block';
                } else {
                    if (adminLinkDesktop) adminLinkDesktop.style.display = 'none';
                    if (adminLinkMobile) adminLinkMobile.style.display = 'none';
                }
            } else {
                // Show login/register
                registerLinks.forEach(link => link.style.display = 'inline');
                loginLinks.forEach(link => link.style.display = 'inline-flex');

                // Hide user menu and admin links
                if (userMenu) userMenu.style.display = 'none';
                if (userMenuMobile) userMenuMobile.style.display = 'none';
                if (adminLinkDesktop) adminLinkDesktop.style.display = 'none';
                if (adminLinkMobile) adminLinkMobile.style.display = 'none';
            }
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        // Step navigation
        function showStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            
            // Show current step
            document.getElementById(`step-${step}`).classList.remove('hidden');
            
            // Update progress
            updateProgress(step);
            
            currentStep = step;
        }

        function updateProgress(step) {
            const progress = (step / 4) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('current-step').textContent = step;
            
            // Update step labels
            const labels = document.querySelectorAll('.progress-bar + div span');
            labels.forEach((label, index) => {
                if (index < step - 1) {
                    label.classList.add('font-medium', 'text-success');
                    label.classList.remove('text-text-secondary');
                } else if (index === step - 1) {
                    label.classList.add('font-medium', 'text-primary');
                    label.classList.remove('text-text-secondary');
                } else {
                    label.classList.add('text-text-secondary');
                    label.classList.remove('font-medium', 'text-primary', 'text-success');
                }
            });
        }

        // Category selection
        document.querySelectorAll('.category-card').forEach(card => {
            card.addEventListener('click', function() {
                // Remove previous selection
                document.querySelectorAll('.category-card').forEach(c => {
                    c.classList.remove('ring-2', 'ring-primary', 'bg-primary-50');
                });
                
                // Add selection to clicked card
                this.classList.add('ring-2', 'ring-primary', 'bg-primary-50');
                
                selectedCategory = this.dataset.category;
                document.getElementById('next-step-1').disabled = false;
                
                // Show AI suggestions
                showAISuggestions(selectedCategory);
            });
        });

        function showAISuggestions(category) {
            const suggestions = {
                'infrastructure': [
                    'Pothole repair on MG Road - Resolved in 3 days',
                    'Street light not working - Fixed within 24 hours',
                    'Water pipeline burst - Repaired in 2 days'
                ],
                'public-services': [
                    'Birth certificate delay - Processed in 1 day',
                    'Ration card issue - Resolved in 4 days',
                    'School admission problem - Sorted in 2 days'
                ],
                'corruption': [
                    'Bribery demand for license - Action taken in 7 days',
                    'Unfair treatment at office - Official warned in 5 days'
                ],
                'environmental': [
                    'Illegal dumping of waste - Cleaned in 2 days',
                    'Air pollution from factory - Inspection done in 3 days'
                ],
                'safety': [
                    'Broken traffic signal - Fixed in 1 day',
                    'Unsafe construction site - Secured in 2 days'
                ],
                'other': [
                    'General complaint - Reviewed in 3-5 days'
                ]
            };

            const suggestionList = document.getElementById('suggestion-list');
            suggestionList.innerHTML = '';
            
            suggestions[category]?.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'text-sm text-text-secondary bg-white rounded-lg p-3 border border-primary-200';
                div.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-success mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                        </svg>
                        ${suggestion}
                    </div>
                `;
                suggestionList.appendChild(div);
            });
            
            document.getElementById('ai-suggestions').classList.remove('hidden');
        }

        // Form validation
        function validateStep2() {
            const subject = document.getElementById('subject').value.trim();
            const description = document.getElementById('description').value.trim();
            const priority = document.querySelector('input[name="priority"]:checked');
            const category = document.getElementById('step2-category').value;

            const isValid = subject.length > 0 && description.length > 10 && priority && category;
            document.getElementById('next-step-2').disabled = !isValid;

            return isValid;
        }



        // Character counters
        document.getElementById('subject').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('subject-count').textContent = `${count}/100`;
            validateStep2();
        });

        document.getElementById('description').addEventListener('input', function() {
            const count = this.value.length;
            document.getElementById('description-count').textContent = `${count}/2000`;
            validateStep2();
        });

        // Priority selection
        document.querySelectorAll('input[name="priority"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // Remove previous selection styling
                document.querySelectorAll('.priority-option div').forEach(div => {
                    div.classList.remove('border-success', 'border-warning', 'border-error', 'bg-success-50', 'bg-warning-50', 'bg-error-50');
                    div.classList.add('border-gray-200');
                });
                
                // Add selection styling
                const parentDiv = this.closest('.priority-option').querySelector('div');
                const value = this.value;
                parentDiv.classList.remove('border-gray-200');
                
                if (value === 'low') {
                    parentDiv.classList.add('border-success', 'bg-success-50');
                } else if (value === 'medium') {
                    parentDiv.classList.add('border-warning', 'bg-warning-50');
                } else if (value === 'high') {
                    parentDiv.classList.add('border-error', 'bg-error-50');
                }
                
                validateStep2();
            });
        });

        // Location validation
        ['address', 'city', 'district'].forEach(id => {
            document.getElementById(id).addEventListener('input', validateStep3);
        });

        document.getElementById('state').addEventListener('change', validateStep3);

        document.getElementById('pincode').addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').slice(0, 6);
            validateStep3();
        });

        // Reverse geocoding function using Nominatim API
        async function reverseGeocode(lat, lng) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&zoom=18`);
                const data = await response.json();

                if (data && data.address) {
                    return {
                        address: data.address.house_number ? `${data.address.house_number} ${data.address.road || data.address.pedestrian || data.address.path || ''}`.trim() : (data.address.road || data.address.pedestrian || data.address.path || data.display_name.split(',')[0]),
                        city: data.address.city || data.address.town || data.address.village || data.address.municipality || '',
                        state: data.address.state || '',
                        district: data.address.county || data.address.state_district || '',
                        pincode: data.address.postcode || '',
                        landmark: data.address.neighbourhood || data.address.suburb || ''
                    };
                }
                return null;
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                return null;
            }
        }

        // Location detection
        document.getElementById('detect-location').addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser. Please enter your location manually.');
                return;
            }

            // Request location permission and get current position
            this.innerHTML = '<svg class="w-4 h-4 mr-1 inline animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Getting location permission...';

            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const button = document.getElementById('detect-location');
                    button.innerHTML = '<svg class="w-4 h-4 mr-1 inline animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Detecting accurate location...';

                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // Get accurate address details using reverse geocoding
                    const addressData = await reverseGeocode(lat, lng);

                    if (addressData) {
                        // Populate form with accurate location data
                        document.getElementById('address').value = addressData.address || '';
                        document.getElementById('city').value = addressData.city || '';
                        document.getElementById('district').value = addressData.district || '';

                        // Map state to select option value
                        const stateSelect = document.getElementById('state');
                        const stateValue = mapStateToValue(addressData.state);
                        if (stateValue) {
                            stateSelect.value = stateValue;
                        }

                        document.getElementById('pincode').value = addressData.pincode || '';
                        document.getElementById('landmark').value = addressData.landmark || '';

                        button.innerHTML = '<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Location detected successfully';

                        // Validate the form after populating
                        validateStep3();

                        // Reset button text after 3 seconds
                        setTimeout(() => {
                            button.innerHTML = '<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Use my current location';
                        }, 3000);
                    } else {
                        button.innerHTML = '<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Use my current location';
                        alert('Unable to get accurate address details. Please enter your location manually.');
                    }
                },
                function(error) {
                    const button = document.getElementById('detect-location');
                    button.innerHTML = '<svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>Use my current location';

                    let errorMessage = 'Unable to detect location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Location permission was denied. Please allow location access and try again, or enter your location manually.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information is unavailable. Please enter your location manually.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out. Please try again or enter your location manually.';
                            break;
                        default:
                            errorMessage += 'An unknown error occurred. Please enter your location manually.';
                            break;
                    }
                    alert(errorMessage);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                }
            );
        });

        // Helper function to map state names to select option values
        function mapStateToValue(stateName) {
            if (!stateName) return '';

            const stateMap = {
                'maharashtra': ['maharashtra', 'maharastra', 'mh'],
                'karnataka': ['karnataka', 'karnatak', 'ka'],
                'tamil nadu': ['tamil nadu', 'tamilnadu', 'tn'],
                'delhi': ['delhi', 'new delhi', 'dl'],
                'gujarat': ['gujarat', 'gj'],
                'rajasthan': ['rajasthan', 'rj'],
                'uttar pradesh': ['uttar pradesh', 'up'],
                'west bengal': ['west bengal', 'wb']
            };

            const normalizedState = stateName.toLowerCase().trim();

            for (const [value, aliases] of Object.entries(stateMap)) {
                if (aliases.some(alias => normalizedState.includes(alias))) {
                    return value;
                }
            }

            return '';
        }

        // File upload
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');

        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('border-primary', 'bg-primary-50');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('border-primary', 'bg-primary-50');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('border-primary', 'bg-primary-50');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            filePreview.classList.remove('hidden');
            filePreview.innerHTML = '';
            
            Array.from(files).forEach((file, index) => {
                if (file.size > 10 * 1024 * 1024) {
                    alert(`File ${file.name} is too large. Maximum size is 10MB.`);
                    return;
                }
                
                const fileDiv = document.createElement('div');
                fileDiv.className = 'flex items-center justify-between bg-gray-50 rounded-lg p-3';
                fileDiv.innerHTML = `
                    <div class="flex items-center">
                        <svg class="w-8 h-8 text-gray-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <div>
                            <div class="font-medium text-text-primary">${file.name}</div>
                            <div class="text-sm text-text-secondary">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    </div>
                    <button type="button" class="text-error hover:text-error-700 transition-colors" onclick="removeFile(this)">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;
                filePreview.appendChild(fileDiv);
            });
        }

        function removeFile(button) {
            button.closest('div').remove();
            if (filePreview.children.length === 0) {
                filePreview.classList.add('hidden');
            }
        }

        // Voice input using Web Speech API
        let recognition = null;
        let isListening = false;

        // Check if browser supports speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US'; // You can change this to support other languages

            recognition.onstart = function() {
                isListening = true;
                const button = document.getElementById('voice-input');
                button.innerHTML = '<svg class="w-5 h-5 animate-pulse text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path></svg>';
                button.title = 'Listening... Click to stop';
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const textarea = document.getElementById('description');
                textarea.value += (textarea.value ? ' ' : '') + transcript;
                textarea.dispatchEvent(new Event('input'));
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                alert('Voice recognition error: ' + event.error + '. Please try again or type manually.');
            };

            recognition.onend = function() {
                isListening = false;
                const button = document.getElementById('voice-input');
                button.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>';
                button.title = 'Voice input';
            };
        }

        document.getElementById('voice-input').addEventListener('click', function() {
            if (!recognition) {
                alert('Voice recognition is not supported in this browser. Please use Chrome, Edge, or Safari for voice input functionality.');
                return;
            }

            if (isListening) {
                recognition.stop();
            } else {
                // Request microphone permission and start recognition
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function(stream) {
                        recognition.start();
                    })
                    .catch(function(err) {
                        console.error('Microphone access denied:', err);
                        alert('Microphone access is required for voice input. Please allow microphone access and try again.');
                    });
            }
        });

        // Step navigation buttons
        document.getElementById('next-step-1').addEventListener('click', () => showStep(2));
        document.getElementById('prev-step-2').addEventListener('click', () => showStep(1));
        document.getElementById('next-step-2').addEventListener('click', () => showStep(3));
        document.getElementById('prev-step-3').addEventListener('click', () => showStep(2));
        document.getElementById('next-step-3').addEventListener('click', () => {
            if (!document.getElementById('next-step-3').disabled) {
                populateReview();
                showStep(4);
            }
        });
        document.getElementById('prev-step-4').addEventListener('click', () => showStep(3));

        // Terms agreement
        document.getElementById('terms-agreement').addEventListener('change', function() {
            document.getElementById('submit-grievance').disabled = !this.checked;
        });

        // Populate review step
        function populateReview() {
            const categoryNames = {
                'infrastructure': 'Infrastructure',
                'public-services': 'Public Services',
                'corruption': 'Corruption',
                'environmental': 'Environmental',
                'safety': 'Safety & Security',
                'other': 'Other Issues'
            };

            document.getElementById('review-category').textContent = categoryNames[selectedCategory];
            document.getElementById('review-subject').textContent = document.getElementById('subject').value;
            document.getElementById('review-description').textContent = document.getElementById('description').value;

            // Get state display name from selected option
            const stateSelect = document.getElementById('state');
            const stateDisplay = stateSelect.options[stateSelect.selectedIndex]?.text || document.getElementById('state').value;

            const location = `${document.getElementById('address').value}, ${document.getElementById('district').value}, ${document.getElementById('city').value}, ${stateDisplay} - ${document.getElementById('pincode').value}`;
            document.getElementById('review-location').textContent = location;

            const priority = document.querySelector('input[name="priority"]:checked')?.value;
            const priorityBadge = document.getElementById('review-priority');
            priorityBadge.textContent = `${priority.charAt(0).toUpperCase() + priority.slice(1)} Priority`;
            priorityBadge.className = `status-badge status-${priority === 'high' ? 'error' : priority === 'medium' ? 'warning' : 'success'}`;
        }

        // Submit grievance
        document.getElementById('submit-grievance').addEventListener('click', async function() {
            // Check if user is logged in
            const userToken = localStorage.getItem('token');

            if (!userToken) {
                // Show login prompt modal
                document.getElementById('login-prompt-modal').classList.remove('hidden');
                return;
            }

            this.disabled = true;
            this.innerHTML = '<svg class="w-5 h-5 mr-2 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Submitting...';

            try {
                // Collect form data
                const location = {
                    address: document.getElementById('address').value.trim(),
                    city: document.getElementById('city').value.trim(),
                    state: document.getElementById('state').value,
                    district: document.getElementById('district').value.trim(),
                    pincode: document.getElementById('pincode').value.trim(),
                    landmark: document.getElementById('landmark').value.trim()
                };

                const grievanceData = {
                    category: selectedCategory,
                    subject: document.getElementById('subject').value.trim(),
                    description: document.getElementById('description').value.trim(),
                    location: location
                };

                // Send to backend API
                const response = await fetch('http://localhost:5000/grievances/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify(grievanceData)
                });

                const result = await response.json();

                if (response.ok) {
                    // Show success with the reference ID from backend
                    document.getElementById('tracking-id').textContent = result.reference_id;
                    document.getElementById('success-modal').classList.remove('hidden');
                } else {
                    // Handle error
                    alert('Error submitting grievance: ' + (result.error || 'Unknown error'));
                }

            } catch (error) {
                console.error('Submission error:', error);
                alert('Error submitting grievance. Please try again.');
            } finally {
                this.disabled = false;
                this.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>Submit Grievance';
            }
        });

        function closeSuccessModal() {
            document.getElementById('success-modal').classList.add('hidden');
            // Reset form
            location.reload();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateHeader();
            showStep(1);
        });

        // Auto-save draft (mock implementation)
        let draftTimer;
        function saveDraft() {
            clearTimeout(draftTimer);
            draftTimer = setTimeout(() => {
                const draftData = {
                    category: selectedCategory,
                    subject: document.getElementById('subject').value,
                    description: document.getElementById('description').value,
                    priority: document.querySelector('input[name="priority"]:checked')?.value,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('grievance_draft', JSON.stringify(draftData));
            }, 1000);
        }

        // Add auto-save listeners
        ['subject', 'description'].forEach(id => {
            document.getElementById(id).addEventListener('input', saveDraft);
        });

        document.querySelectorAll('input[name="priority"]').forEach(radio => {
            radio.addEventListener('change', saveDraft);
        });
    </script>
    <script>
// -------------------- STEP 3 â STEP 4 -----------------------
// --------------------- STEP 3 â STEP 4 NAVIGATION ---------------------
document.getElementById("next-step-3").addEventListener("click", () => {
    if (!document.getElementById("next-step-3").disabled) {
        document.getElementById("step-3").classList.add("hidden");
        document.getElementById("step-4").classList.remove("hidden");

        fillReviewData();  // ensure review page shows real values
    }
});

function fillReviewData() {
    // Fetch TEXT fields from Step 1 & Step 2 (already working in your project)
    const category = document.getElementById("category")?.value || "";
    const subject = document.getElementById("subject")?.value || "";
    const description = document.getElementById("description")?.value || "";

    // Fetch LOCATION fields from Step 3
    const address = document.getElementById("address").value;
    const city = document.getElementById("city").value;
    const state = document.getElementById("state").value;
    const district = document.getElementById("district").value;
    const pincode = document.getElementById("pincode").value;

    const fullLocation = `${address}, ${district}, ${city}, ${state} - ${pincode}`;

    // Push values to Review Page
    document.getElementById("review-category").textContent = category;
    document.getElementById("review-subject").textContent = subject;
    document.getElementById("review-description").textContent = description;
    document.getElementById("review-location").textContent = fullLocation;
}

</script>

<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>